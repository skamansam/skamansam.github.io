
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Data Migrations and You! - Rude Boy Solutions</title>
  <meta name="author" content=""Skaman Sam" Tyler">

  
  <meta name="description" content="A Little Background The university from which I graduated did not teach any programming patterns, so when I entered the job market, I was not sure &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://skamansam.github.io/blog/2016/09/14/data-migrations-and-you/">
  <link href="/images/favicons/apple-touch-icon-57x57.png" rel="apple-touch-icon" sizes="57x57"/>
<link href="/images/favicons/apple-touch-icon-60x60.png" rel="apple-touch-icon" sizes="60x60"/>
<link href="/images/favicons/apple-touch-icon-72x72.png" rel="apple-touch-icon" sizes="72x72"/>
<link href="/images/favicons/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76"/>
<link href="/images/favicons/apple-touch-icon-114x114.png" rel="apple-touch-icon" sizes="114x114"/>
<link href="/images/favicons/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120"/>
<link href="/images/favicons/apple-touch-icon-144x144.png" rel="apple-touch-icon" sizes="144x144"/>
<link href="/images/favicons/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152"/>
<link href="/images/favicons/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180"/>
<link href="/images/favicons/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/>
<link href="/images/favicons/android-chrome-192x192.png" rel="icon" sizes="192x192" type="image/png"/>
<link href="/images/favicons/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png"/>
<link href="/images/favicons/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/>
<link href="/images/favicons/manifest.json" rel="manifest"/>
<meta content="#da532c" name="msapplication-TileColor"/>
<meta content="/images/favicons/mstile-144x144.png" name="msapplication-TileImage"/>
<meta content="#ffffff" name="theme-color"/>

  <link href="/atom.xml" rel="alternate" title="Rude Boy Solutions" type="application/atom+xml">

  <!-- include modernizr and jquery -->
  <script src="/javascripts/modernizr-2.0.js"></script>
  <!--<script src="/javascripts/libs/jquery.min.js"></script>-->

  <!-- include jquery if it isn't already -->
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>

  <!-- includes for octopress -->
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/octopress.js" type="text/javascript"></script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<!-- For latex rendering with katex -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/contrib/auto-render.min.js"></script>

<!-- For chart rendering with mermaid 6.0.0 -->
<link rel="stylesheet" href="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.css">
<script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
<!-- <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaidAPI.min.js"></script> -->
<script>mermaid.initialize({startOnLoad:false, cloneCssStyles: false});</script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-4371156-6']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><img src="/images/logo.gif" id="logo_header_image"/>
<hgroup>
  <h1><a href="/">Rude Boy Solutions</a></h1>
  
    <h2>Solutions. For Life.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="skamansam@gmail.com" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="skamansam.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/music.html">Music</a></li>
  <li><a href="https://plus.google.com/collection/8RHyXB">Photos</a></li>
  <li><a href="/about.html">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Data Migrations and You!</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-09-14T10:06:59-04:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>10:06 am</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://skamansam.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h2>A Little Background</h2>

<p>The university from which I graduated did not teach any programming patterns, so when I entered the job market, I was not sure what <em>programming patterns</em> (a.k.a. &ldquo;<em>design patterns</em>&rdquo;)Â even were. My first job was definitely a learning experience, but since I was on a small team with other newbies, I didn&rsquo;t have many opportunities to grow well as a developer. So when I got my second job, with developers of all walks and experiences, I was thrown into many, many discussions about what pattern to apply to what idea. It was a little confusing at first, but very exhilarating! Here was the chance to lose some old, bad habits, and replace them with new <em>Patterns</em>! This post is about some patterns I really really like. I will add references and information about each pattern so you can learn as much about them them as you want!</p>

<h2>Migrations Are Only For Modifying The Database</h2>

<p>This is a difficult rule to follow for lots of Rails developers, experienced and not so. Since migrations are usually automated, it is easy to get in the mindset of adding data changes to migrations. This violates the <strong>Single Responsibility Principle</strong>, which states, <em>A class should have a responsibility over a single feature of your application</em>.</p>

<div class='note'>
Scenario: You have a nice chat app and you want to add the ability for users to 'favorite' certain messages. At first, you have a boolean field in your database, so your original migration looks like this:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreateMessageFavorites</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:message_favorites</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">references</span> <span class="ss">:message</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">references</span> <span class="ss">:user</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">boolean</span>    <span class="ss">:favorite</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>  <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
</span><span class='line'>    <span class="n">drop_table</span> <span class="ss">:message_favorites</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>
After a few months, and many _many_ messages (6 million!), you decide you want the 'favorite' button to handle a few more emotions, such as "makes me happy," "makes me sad," "makes me angry," "makes me crazy," and "meh, just a note."</div>


<p>There are several ways of going about doing this. Once you analyze your requirements, you decide to use the existing <code>MessageFavorite#favorite</code> field to store the new information.Your immediate thought is to use a migration as such:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">UpdateMessageFavoritesToHandleMoreEmotions</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="n">add_column</span> <span class="ss">:message_favorites</span><span class="p">,</span> <span class="ss">:favorite_int</span><span class="p">,</span> <span class="ss">:int</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">MessageFavorite</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">mf</span><span class="o">|</span>
</span><span class='line'>      <span class="n">mf</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="ss">favorite_int</span><span class="p">:</span> <span class="no">MessageFavorite</span><span class="o">::</span><span class="no">EMOTIONS</span><span class="o">[</span><span class="n">mf</span><span class="o">.</span><span class="n">favorite</span> <span class="p">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">remove_column</span> <span class="ss">:message_favorites</span><span class="p">,</span> <span class="ss">:favorite</span>
</span><span class='line'>    <span class="n">rename_column</span> <span class="ss">:message_favorites</span><span class="p">,</span> <span class="ss">:favorite_int</span><span class="p">,</span> <span class="ss">:favorite</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are a few problems with this approach, chiefly, running a data migration in the middle of a Rails migration like this is going to grind things to a halt. Your deploy is going to take forever! There is also an issue of what happens when there is an error in your data migration which will prevent everything from happening and could leave you with dangling data that another migration won&rsquo;t be able to fix.</p>

<p>Change in environment is also a big issue. You may have this thoroughly tested while in development or in testing environments, but production is known to throw a wrench into the works. This untested environment means you need to baby-sit your data migration, which you won&rsquo;t be able to do while it&rsquo;s in a deploy migration. You will need to run this separately, in a production console.</p>

<p>Finally, there is the obvious issue of violations to the <strong>SRP</strong>. This migration does three things:</p>

<ol>
<li>creates a new temporary column</li>
<li>creates the new data based on the existing data</li>
<li>replaces the original column with the new column</li>
</ol>


<p>The best way to address all these issues is to just break the migration up into its distinct pieces, by doing the following:</p>

<ol>
<li>create and run a migration to create a new column in the Db</li>
<li>run the data migration (in the production console)</li>
<li>create and run a migration to replace the old column with the new one</li>
</ol>


<p>For many of us, step 2 is a very daunting task. Rails consoles in production are a hairy endeavor and can lead to bad data integrity and other sorts of bad things, including deleting all data! Fortunately for you guys, Rails already has a solution for this.</p>

<h3>Introducing Rails Runner</h3>

<p>Rails runner is a great tool for running data migrations and other one-shot data changes in your Rails application. Rails runner runs a given file in the context of your Rails app. You can execute Rails runner as <code>rails runner bin/file.rb</code> or <code>rails r bin/file.rb</code>. While this won&rsquo;t solve data integrity issues, it will allow you to run a script in the current Rails context. This means you can have tested and peer reviewed data migrations! Amazing!</p>

<p>For ease of organization, you can put all your data migrations in <code>db/migrate/data/</code>. Another common place is <code>bin/one-shot/:year/:month/</code>. If this is a hotfix for a tech support ticket, it is helpful to put the ticket number in the name of the file, for instance <code>bin/one-shot/2016/09/TS-432098-update-bad-data.rb</code>. The point is, your team should agree on a place to put all these tickets so everyone can keep track of the changes. Developers can add a <code>post_checkout</code> git hook to automatically run all new scripts in the agreed-upon directory.</p>

<h3>Flow for Data Migrations</h3>

<div class="chart">
%% Waiting for the following chart to load...
graph TB;
  db?{database needs to be changed?}
  done[Done.]
  db["Run database migration (rails migration)"]
  data?{data need to be changed?}
  data["run script to change data (one-shot)"]
  db_cleanup?{database needs cleanup?}
  db? -- yes --> db
  db? -- no  --> done
  db  --> data?
  data? -- no -->done
  data? -- yes --> data
  data --> db_cleanup?
  db_cleanup? -- yes --> db
  db_cleanup? -- no --> done
</div>


<p>If you want to run any migration in Rails, just follow these easy steps:</p>

<ol>
<li>For data migrations, create a one-shot and use <code>rails runner</code>. This is a best practice because it allows your team to test and review your changes. <strong>NEVER EVER EVER RUN A PRODUCTION CONSOLE!</strong></li>
<li>Use <code>rails migrations</code> <strong>FOR DATABASE MODEL CHANGES ONLY</strong></li>
<li>Apply rules <em>1</em> and <em>2</em> as liberally as possible.</li>
</ol>


<p>If you want to create a data migration, use one-shots. If you want to create a data migration with a database change, separate the two concerns into a Rails migration, then a data migration, then a cleanup migration if needed. Of course, YMMV, as with any best practice, just make sure your team is onboard with it and, above all, remember that agreeing on standard practices is the core of a happy team!</p>

<!--
## Presenting Presenters
[About Presenters, decorator pattern]

## Interacting With Objects
[about interactors, service object patters]

## Keeping Controllers Under Control
[about controllers as parameter fetchers for other objects that actuall do the work]

## ActiveRecord Is For Recording
[AR models should be only datastore - allows for switching DBs out - SQL should all be here - when switching Dbs, you only need to edit the models]

## Views: A New View
[use jbuilder/jb, separate views for each format, instead of `render :json...`]

## Proper Tooling
[Use tools! Use gems! Research which ones work for you and your team. Do not reinvent the wheel!]
-->

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">"Skaman Sam" Tyler</span></span>

      




<time class='entry-date' datetime='2016-09-14T10:06:59-04:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>10:06 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/best-practices/'>best practices</a>, <a class='category' href='/blog/categories/design-patterns/'>design patterns</a>, <a class='category' href='/blog/categories/programming/'>programming</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>, <a class='category' href='/blog/categories/ruby-on-rails/'>ruby on rails</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://skamansam.github.io/blog/2016/09/14/data-migrations-and-you/" data-via="skamansam" data-counturl="http://skamansam.github.io/blog/2016/09/14/data-migrations-and-you/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/09/14/fun-with-numbers/" title="Previous Post: Fun With Numbers! (revised)">&laquo; Fun With Numbers! (revised)</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/09/14/data-migrations-and-you/">Data Migrations and You!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/09/14/fun-with-numbers/">Fun With Numbers! (Revised)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/30/moved-to-octopress/">Moved to Octopress!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/23/cookie-detection-in-rails-3/">Cookie Detection in Rails 3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/10/building-a-unified-time-select-field/">Building a Unified Time_select Field</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/skamansam">@skamansam</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'skamansam',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/skamansam?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - "Skaman Sam" Tyler -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'rudeboysolutions';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://skamansam.github.io/blog/2016/09/14/data-migrations-and-you/';
        var disqus_url = 'http://skamansam.github.io/blog/2016/09/14/data-migrations-and-you/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<script>

var onloadhandler = function(){
  render_mermaid()
  render_latex()
}

var render_mermaid = function(){
  var elements = document.querySelectorAll(".chart");
  console.info('elements:', elements)
  for(i  in elements){
    var element = elements[i];
    var insertSvg = function(svgCode, bindFunctions){
        element.innerHTML = svgCode;
    };

    var graphDefinition = element.textContent;
    var graph = mermaidAPI.render('graphDiv', graphDefinition, insertSvg);
  }
}

var render_latex = function() {
  var tex_elements = document.querySelectorAll('.tex')
  for(elem_idx in tex_elements){
    elem = tex_elements[elem_idx]
    renderMathInElement(
      elem,
      {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "$", right: "$", display: false},
            {left: "\\(", right: "\\)", display: false}
        ]
      }
    )
  }
}

if(window.attachEvent) {
  window.attachEvent('onload', onloadhandler);
} else {
  if(window.onload) {
      var curronload = window.onload;
      var newonload = function(evt) {
          curronload(evt);
          onloadhandler();
      };
      window.onload = newonload;
  } else {
      window.onload = onloadhandler;
  }
}

</script>


</body>
</html>
